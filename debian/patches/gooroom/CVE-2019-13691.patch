commit 948742761f636702c927b243046836cceeb050fd
Author: Arthur Hemery <ahemery@chromium.org>
Date:   Wed Sep 18 10:06:24 2019 +0000

    Navigation: Clear pending entry when overriding navigation

    When going through NavigateFromFrameProxy, it is possible to cancel an
    ongoing browser initiated navigation if we have a navigation that moved
    from the FrameTreeNode to the RenderFrameHost already. In this case
    however, under specific timing conditions, and if this new navigation
    does not commit, we could be left in a state that has a pending
    navigation entry to the original browser initiated navigation,
    effectively spoofing the URL.

    To make sure we do not leave the pending navigation entry hanging, we
    discard it as soon as we try to do another navigation and cancel the
    original one.

    Bug: 966914
    Change-Id: Ib9b66bd87f072b89465da0793296142cf8523cb9
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/1751205
    Commit-Queue: Arthur Hemery <ahemery@chromium.org>
    Reviewed-by: Arthur Sonzogni <arthursonzogni@chromium.org>
    Cr-Commit-Position: refs/heads/master@{#697540}

diff --git a/content/browser/frame_host/navigation_controller_impl.cc b/content/browser/frame_host/navigation_controller_impl.cc
index 66e707e1c984..8bf9078a6cb8 100644
--- a/content/browser/frame_host/navigation_controller_impl.cc
+++ b/content/browser/frame_host/navigation_controller_impl.cc
@@ -2327,6 +2327,11 @@ void NavigationControllerImpl::NavigateFromFrameProxy(
   if (!request)
     return;
 
+  // At this stage we are proceeding with this navigation. If this was renderer
+  // initiated with user gesture, we need to make sure we clear up potential
+  // remains of a cancelled browser initiated navigation to avoid URL spoofs.
+  DiscardNonCommittedEntries();
+
   render_frame_host->frame_tree_node()->navigator()->Navigate(
       std::move(request), ReloadType::NONE, RestoreType::NONE);
 }
