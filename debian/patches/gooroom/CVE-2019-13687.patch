commit b740a6052b00ebeec4bdc3044a130aab0c64ab05
Author: Armando Miraglia <armax@chromium.org>
Date:   Fri Sep 6 12:47:49 2019 +0000

    [Video Capture Manager] Convert pointers from Unretained to WeakPtr.
    
    This CL replaces the usage of unretained pointers with weak pointers
    in VideoCaptureManager.
    
    This conversion is safe because all places where the pointers are saved
    are on the IO thread as well as the place were the callbacks are then
    executed (see line 326 and 348).
    
    BUG=998548
    
    Change-Id: I47bda798fa7bcbd66bf23682ee6c6dd26b5642c1
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/1789223
    Reviewed-by: Guido Urdaneta <guidou@chromium.org>
    Commit-Queue: Armando Miraglia <armax@chromium.org>
    Cr-Commit-Position: refs/heads/master@{#694214}

diff --git a/content/browser/renderer_host/media/video_capture_manager.cc b/content/browser/renderer_host/media/video_capture_manager.cc
index 08b7ef4c56f2..84b796fb660a 100644
--- a/content/browser/renderer_host/media/video_capture_manager.cc
+++ b/content/browser/renderer_host/media/video_capture_manager.cc
@@ -648,8 +648,7 @@ void VideoCaptureManager::GetPhotoState(
     media::VideoCaptureDevice::GetPhotoStateCallback callback) {
   DCHECK_CURRENTLY_ON(BrowserThread::IO);
 
-  const VideoCaptureController* controller =
-      LookupControllerBySessionId(session_id);
+  VideoCaptureController* controller = LookupControllerBySessionId(session_id);
   if (!controller)
     return;
   if (controller->IsDeviceAlive()) {
@@ -660,7 +659,7 @@ void VideoCaptureManager::GetPhotoState(
   photo_request_queue_.emplace_back(
       session_id,
       base::Bind(&VideoCaptureController::GetPhotoState,
-                 base::Unretained(controller), base::Passed(&callback)));
+                 controller->GetWeakPtrForIOThread(), base::Passed(&callback)));
 }
 
 void VideoCaptureManager::SetPhotoOptions(
@@ -679,7 +678,7 @@ void VideoCaptureManager::SetPhotoOptions(
   // Queue up a request for later.
   photo_request_queue_.emplace_back(
       session_id, base::Bind(&VideoCaptureController::SetPhotoOptions,
-                             base::Unretained(controller),
+                             controller->GetWeakPtrForIOThread(),
                              base::Passed(&settings), base::Passed(&callback)));
 }
 
@@ -705,7 +704,7 @@ void VideoCaptureManager::TakePhoto(
   photo_request_queue_.emplace_back(
       session_id,
       base::Bind(&VideoCaptureController::TakePhoto,
-                 base::Unretained(controller), base::Passed(&callback)));
+                 controller->GetWeakPtrForIOThread(), base::Passed(&callback)));
 }
 
 void VideoCaptureManager::OnOpened(
