commit cfd44efa92afda3eb1944ae2f862bd444553a78c
Author: Antonio Gomes <tonikitoo@igalia.com>
Date:   Fri Aug 9 20:14:51 2019 +0000

    Close FileSystemOperationListener bindings on PreFinalizer

    This is a speculative CL to the UAP observed on crbug.com/c/981492.
    It basically early-closes FileSystemDispatcher's mojo bindings manually,
    a common for Blink's GC objects that own mojo bindings.

    BUG=981492
    R=haraken@chromium.org, mek@chromium.org

    Change-Id: I0ffff4798532df5dda1ee74e4bbe8a887b5c68ee
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/1744375
    Reviewed-by: Marijn Kruisselbrink <mek@chromium.org>
    Reviewed-by: Kentaro Hara <haraken@chromium.org>
    Commit-Queue: Marijn Kruisselbrink <mek@chromium.org>
    Auto-Submit: Antonio Gomes <tonikitoo@igalia.com>
    Cr-Commit-Position: refs/heads/master@{#685700}

diff --git a/third_party/blink/renderer/modules/filesystem/file_system_dispatcher.cc b/third_party/blink/renderer/modules/filesystem/file_system_dispatcher.cc
index 1ded9d9e733a..1931e1080d1a 100644
--- a/third_party/blink/renderer/modules/filesystem/file_system_dispatcher.cc
+++ b/third_party/blink/renderer/modules/filesystem/file_system_dispatcher.cc
@@ -598,4 +598,8 @@ void FileSystemDispatcher::RemoveOperationPtr(int operation_id) {
   cancellable_operations_.erase(operation_id);
 }
 
+void FileSystemDispatcher::Prefinalize() {
+  op_listeners_.CloseAllBindings();
+}
+
 }  // namespace blink
diff --git a/third_party/blink/renderer/modules/filesystem/file_system_dispatcher.h b/third_party/blink/renderer/modules/filesystem/file_system_dispatcher.h
index 16a11622dacd..2e59f8245038 100644
--- a/third_party/blink/renderer/modules/filesystem/file_system_dispatcher.h
+++ b/third_party/blink/renderer/modules/filesystem/file_system_dispatcher.h
@@ -30,6 +30,7 @@ class FileSystemDispatcher
     : public GarbageCollectedFinalized<FileSystemDispatcher>,
       public Supplement<ExecutionContext> {
   USING_GARBAGE_COLLECTED_MIXIN(FileSystemDispatcher);
+  USING_PRE_FINALIZER(FileSystemDispatcher, Prefinalize);
 
  public:
   using StatusCallback = base::OnceCallback<void(base::File::Error error)>;
@@ -193,6 +194,8 @@ class FileSystemDispatcher
 
   void RemoveOperationPtr(int operation_id);
 
+  void Prefinalize();
+
   mojom::blink::FileSystemManagerPtr file_system_manager_ptr_;
   using OperationsMap =
       HashMap<int, mojom::blink::FileSystemCancellableOperationPtr>;
