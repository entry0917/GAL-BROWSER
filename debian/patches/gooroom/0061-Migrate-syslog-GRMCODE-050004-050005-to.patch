From 58bc3311c53f4686fd3ce9a1378de245eae3f41c Mon Sep 17 00:00:00 2001
From: junsungc <junsungc@gooroom.kr>
Date: Fri, 6 Sep 2019 10:05:25 +0900
Subject: [PATCH 61/78] Migrate syslog 'GRMCODE=050004, 050005' to 
 'GooroomPref::setup()' to check once at browser startup

---
 .../core/common/config_dir_policy_loader.cc   |  9 ------
 gooroom/browser/gooroom_pref.cc               | 28 +++++++++++++++++--
 2 files changed, 25 insertions(+), 12 deletions(-)

diff --git a/components/policy/core/common/config_dir_policy_loader.cc b/components/policy/core/common/config_dir_policy_loader.cc
index b5b86fac2ef5..6a81e761bfab 100644
--- a/components/policy/core/common/config_dir_policy_loader.cc
+++ b/components/policy/core/common/config_dir_policy_loader.cc
@@ -18,7 +18,6 @@
 #include "base/json/json_reader.h"
 #include "base/logging.h"
 #include "base/stl_util.h"
-#include "base/syslog_logging.h"
 #include "components/policy/core/common/policy_bundle.h"
 #include "components/policy/core/common/policy_load_status.h"
 #include "components/policy/core/common/policy_types.h"
@@ -135,15 +134,7 @@ void ConfigDirPolicyLoader::LoadFromPath(const base::FilePath& path,
   PolicyLoadStatusUmaReporter status;
   if (files.empty()) {
     status.Add(POLICY_LOAD_STATUS_NO_POLICY);
-    if(path.AsUTF8Unsafe().find("managed")!=std::string::npos)
-      SYSLOG(INFO) << "Not-Exist-Policy GRMCODE=050004";
     return;
-  } else {
-    if (path.AsUTF8Unsafe().find("managed")!=std::string::npos) {
-      char buff[100] = {0,};
-      snprintf(buff, sizeof(buff), "POLICY DIR=$(%s)", path.AsUTF8Unsafe().c_str());
-      SYSLOG(INFO) << buff << " GRMCODE=050005";
-    }
   }
 
   // Start with an empty dictionary and merge the files' contents.
diff --git a/gooroom/browser/gooroom_pref.cc b/gooroom/browser/gooroom_pref.cc
index 73a1931b774c..0ac50df18744 100644
--- a/gooroom/browser/gooroom_pref.cc
+++ b/gooroom/browser/gooroom_pref.cc
@@ -3,6 +3,7 @@
 #include <fstream>
 #include <gtk/gtk.h>
 
+#include "base/files/file_enumerator.h"
 #include "verify_signature.h"
 #include "gooroom/base/gooroom_base.h"
 #include "gooroom/browser/gooroom_url_filter_impl.h"
@@ -232,10 +233,31 @@ void GooroomPref::setup() {
 
   // Gooroom-Browser policy Sign module
   bool validSign = verifySign();
-  if ( validSign ) return;
-  else {
+  if (!validSign) {
     noVerifySignAlarm();
-	exit(0);
+    exit(0);
+  }
+
+  // Check policies files
+  base::FilePath policies_path;
+  if (base::GetGooroomBase()->isTrustMode())
+    policies_path = base::FilePath("/usr/share/gooroom/browser/policies/trust/managed/");
+  else
+    policies_path = base::FilePath("/usr/share/gooroom/browser/policies/untrust/managed/");
+
+  std::set<base::FilePath> files;
+  base::FileEnumerator file_enumerator(policies_path, false,
+                                       base::FileEnumerator::FILES);
+  for (base::FilePath config_file_path = file_enumerator.Next();
+       !config_file_path.empty(); config_file_path = file_enumerator.Next())
+    files.insert(config_file_path);
+
+  if (files.empty()) {
+    SYSLOG(INFO) << "Not-Exist-Policy GRMCODE=050004";
+  } else {
+    char buff[100] = {0,};
+    snprintf(buff, sizeof(buff), "POLICY DIR=$(%s)", policies_path.AsUTF8Unsafe().c_str());
+    SYSLOG(INFO) << buff << " GRMCODE=050005";
   }
 }
 
-- 
2.20.1

