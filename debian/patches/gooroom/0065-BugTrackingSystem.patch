From 0b378fdd1031e22c749cafd5cec49a1e4d306c46 Mon Sep 17 00:00:00 2001
From: junsungc <junsungc@gooroom.kr>
Date: Fri, 6 Sep 2019 10:46:26 +0900
Subject: [PATCH 65/78] BugTrackingSystem

355 : Re-register the whitelist upon trust/untrust judgement module.
---
 content/browser/web_contents/web_contents_impl.cc |  3 +++
 gooroom/browser/gooroom_pref.cc                   | 11 ++++++++---
 gooroom/browser/gooroom_pref.h                    |  2 ++
 3 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/content/browser/web_contents/web_contents_impl.cc b/content/browser/web_contents/web_contents_impl.cc
index 7241b9bd6cb0..7a441d461642 100644
--- a/content/browser/web_contents/web_contents_impl.cc
+++ b/content/browser/web_contents/web_contents_impl.cc
@@ -16,6 +16,7 @@
 #if BUILDFLAG(ENABLE_GOOROOM)
 #include "base/path_service.h"
 #include "gooroom/base/gooroom_base.h"
+#include "gooroom/browser/gooroom_pref.h"
 #include "dbus/bus.h"
 #include "dbus/message.h"
 #include "dbus/object_path.h"
@@ -4249,6 +4250,8 @@ void WebContentsImpl::DidStartNavigation(NavigationHandle* navigation_handle) {
 const char kUserDataDir[] = "user-data-dir";
 
 bool RequestCurrentUserDataDir(GURL url) {
+  //set whitelist mainpref.json again
+  gooroom::g_gooroom->setMainpref();
   base::GooroomUrlFilter* pFilter = base::GetGooroomBase()->getUrlFilter();
 
   if (!pFilter) return false;
diff --git a/gooroom/browser/gooroom_pref.cc b/gooroom/browser/gooroom_pref.cc
index b6b5f2f2aca5..a5c5d2760807 100644
--- a/gooroom/browser/gooroom_pref.cc
+++ b/gooroom/browser/gooroom_pref.cc
@@ -126,9 +126,7 @@ PrefService* GooroomPref::pref() {
   return pref_.get();
 }
 
-void GooroomPref::setup() {
-  DLOG(INFO) << "GooroomPref::setup() : init gooroom state";
-
+GooroomUrlFilterImpl* GooroomPref::setMainpref() {
   // read CORE policy file from ... ==================================
   // TODO use constant value
   base::FilePath path("/usr/share/gooroom/browser/policies/mainpref.json");
@@ -151,6 +149,13 @@ void GooroomPref::setup() {
   if (p != nullptr)
     pfilterImpl->setWhiteList(p->GetValue());
   base::GetGooroomBase()->setUrlFilter(pfilterImpl);
+  return pfilterImpl;
+}
+
+void GooroomPref::setup() {
+  DLOG(INFO) << "GooroomPref::setup() : init gooroom state";
+
+  GooroomUrlFilterImpl* pfilterImpl = setMainpref();
 
   // if there is a url in command line, check the url is trust to determine the
   // mode whether trust or not.
diff --git a/gooroom/browser/gooroom_pref.h b/gooroom/browser/gooroom_pref.h
index 0c18a6f86f80..c85a112964cd 100644
--- a/gooroom/browser/gooroom_pref.h
+++ b/gooroom/browser/gooroom_pref.h
@@ -9,6 +9,7 @@
 #define GOOROOM_BROWSER_GOOROOM_PREF_H_
 
 #include "components/prefs/pref_service.h"
+#include "gooroom/browser/gooroom_url_filter_impl.h"
 
 namespace gooroom {
 
@@ -30,6 +31,7 @@ class GooroomPref {
   ~GooroomPref();
 
   PrefService* pref();
+  GooroomUrlFilterImpl* setMainpref();
   void setup();
 
   bool useWebSocket();
-- 
2.20.1

